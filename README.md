# Terraform module for EFS

This repo contains a Terraform module to create an AWS EFS.

## Terraform version

- Terraform 0.12: Pin module to `~> 2+`, submit pull request to branch `develop`
- Terraform 0.11: Pin module to `~> 1.x`, submit pull request to branch `terrafomr011`


## Example usages:
See also the [full examples](./examples).

```
module "efs" {
  source = "github.com/philips-software/terraform-aws-efs?ref=terraform012"

  environment    = "${var.environment}"
  subnet_ids     = "${var.private_subnet_ids}"
  vpc_id         = "${var.vpc_id}"
}

# The EFS module outputs user_data parts, which can be used in the following way.
data "template_cloudinit_config" "config" {

  ... other parts ....

  part {
    content_type = "${module.efs.amazon_linux_cloudinit_config_part["content_type"]}"
    content      = "${module.efs.amazon_linux_cloudinit_config_part["content"]}"
  }
}

```

## Inputs

| Name               | Description                                                                                                                                                                                  |     Type     |      Default       | Required |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------: | :----------------: | :------: |
| creation\_token    | A unique name (a maximum of 64 characters are allowed) used as reference when creating the Elastic File System to ensure idempotent file system creation. By default generated by Terraform. |    string    |        `""`        |    no    |
| encrypted          | Encrypt file system.                                                                                                                                                                         |     bool     |      `"true"`      |    no    |
| environment        | Name of the environment; will be prefixed to all resources                                                                                                                                   |    string    |        n/a         |   yes    |
| mount\_location    | Used to create a cloud init config part for amazon linux instances.                                                                                                                          |    string    |      `"/efs"`      |    no    |
| performance\_mode  | maxIO                                                                                                                                                                                        |    string    | `"generalPurpose"` |    no    |
| project            | Name of the project.                                                                                                                                                                         |    string    |        n/a         |   yes    |
| subnet\_ids        | The created EFS will be available in these subnet ids                                                                                                                                        | list(string) |        n/a         |   yes    |
| tags               | A map of tags to add to the resources                                                                                                                                                        | map(string)  |      `<map>`       |    no    |
| transition\_to\_ia | Indicates how long it takes to transition files to the IA storage class. Valid values: AFTER\_7\_DAYS, AFTER\_14\_DAYS, AFTER\_30\_DAYS, AFTER\_60\_DAYS, or AFTER\_90\_DAYS.                |    string    |       `null`       |    no    |
| vpc\_id            | EFS is created in this VPC                                                                                                                                                                   |    string    |        n/a         |   yes    |

## Outputs

| Name                                   | Description                                         |
| -------------------------------------- | --------------------------------------------------- |
| amazon\_linux\_cloudinit\_config\_part | Cloud init part to mount an EFS to an EC2 instance. |
| efs\_dns\_name                         | List of DNS mount points, one per subnet.           |
| efs\_id                                | Id of the EFS file system.                          |


## Automated checks
Currently the automated checks are limited. In CI the following checks are done for the root and each example.
- lint: `terraform validate` and `terraform fmt`
- basic init / get check: `terraform init -get -backend=false -input=false`

## Generation variable documentation
A markdown table for variables can be generated as follow. Generation requires awk and terraform-docs installed.

```
 .ci/bin/terraform-docs.sh markdown .
```

## Philips Forest

This module is part of the Philips Forest.

```
                                                     ___                   _
                                                    / __\__  _ __ ___  ___| |_
                                                   / _\/ _ \| '__/ _ \/ __| __|
                                                  / / | (_) | | |  __/\__ \ |_
                                                  \/   \___/|_|  \___||___/\__|  

                                                                 Infrastructure
```

Talk to the forestkeepers in the `forest`-channel on Slack.

[![Slack](https://philips-software-slackin.now.sh/badge.svg)](https://philips-software-slackin.now.sh)
